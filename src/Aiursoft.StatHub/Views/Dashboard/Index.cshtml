@using Aiursoft.WebTools
@using Aiursoft.CSTools.Tools
@model Aiursoft.StatHub.Models.DashboardViewModels.IndexViewModel
@{
    var showLast30 = ViewBag.Last30Seconds as bool? ?? false;
    var unit = showLast30 ? "/s" : string.Empty;
}

<div class="container-fluid p-0">

    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h3>@Localizer["Agents Dashboard"]</h3>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <div class="btn-group" role="group" aria-label="Data View Toggle">
                @{
                    var cumulativeActive = showLast30 ? "" : "active";
                    var last30Active = showLast30 ? "active" : "";
                }
                <a class="btn btn-light bg-white shadow-sm @cumulativeActive" asp-controller="Dashboard" asp-action="Index" asp-route-Last30Seconds="false">
                    @Localizer["Cumulative"]
                </a>
                <a class="btn btn-light bg-white shadow-sm @last30Active" asp-controller="Dashboard" asp-action="Index" asp-route-Last30Seconds="true">
                    @Localizer["Last 30 seconds"]
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">@Localizer["Agents Status Monitor"]</h5>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-borderless my-0" id="logTable">
                        <thead>
                            <tr>
                                <th>@Localizer["IP"]</th>
                                <th>@Localizer["Name"]</th>
                                <th class="d-none d-lg-table-cell">@Localizer["SKU"]</th>
                                <th class="d-none d-xl-table-cell">@Localizer["Boot at"]</th>
                                <th>@Localizer["Avg Load"]</th>
                                <th>@Localizer["CPU Usage"]</th>
                                <th class="d-none d-lg-table-cell">@Localizer["Used at"]</th>
                                <th>@Localizer["RAM Usage"]</th>
                                @if (showLast30)
                                {
                                    <th class="d-none d-md-table-cell">@Localizer["Net Receiving"]</th>
                                    <th class="d-none d-md-table-cell">@Localizer["Net Sending"]</th>
                                    <th>@Localizer["Disk Used"]</th>
                                    <th class="d-none d-xl-table-cell">@Localizer["Disk Reading"]</th>
                                    <th class="d-none d-xl-table-cell">@Localizer["Disk Writing"]</th>
                                }
                                else
                                {
                                    <th class="d-none d-md-table-cell">@Localizer["Net Received"]</th>
                                    <th class="d-none d-md-table-cell">@Localizer["Net Sent"]</th>
                                    <th>@Localizer["Disk Used"]</th>
                                    <th class="d-none d-xl-table-cell">@Localizer["Disk Read"]</th>
                                    <th class="d-none d-xl-table-cell">@Localizer["Disk Written"]</th>
                                }
                                <th class="d-none d-xl-table-cell">@Localizer["OS"]</th>
                                <th>@Localizer["More"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var agent in Model.Agents)
                            {
                                    // Identify
                                    var isOutDated = agent.LastUpdate < DateTime.UtcNow.AddMinutes(-1);

                                    // Load
                                    var load = agent.GetLoad();
                                    var loadRate = load.Load15M * 30; // Usually Load < 3.33 is safe.
                                    var colorLoad =
                                        loadRate < 10 ? "bg-success" :
                                        loadRate < 15 ? "bg-info" :
                                        loadRate < 30 ? "bg-secondary" :
                                        loadRate < 60 ? "bg-warning" :
                                        "bg-danger";
                                    var promptTextLoad = $"Load:\n1 min: {load.Load1M}\n5 min: {load.Load5M}\n15 min: {load.Load15M}";

                                    // CPU
                                    var cpu = agent.GetCpuUsage();
                                    var cpuRate = cpu.Ratio;
                                    var promptText = $"CPU Usage:\nUser: {cpu.Usr}%\nSystem: {cpu.Sys}%\nIdle: {cpu.Idl}%\nWait: {cpu.Wai}%\nSteal: {cpu.Stl}%";
                                    var color =
                                        cpuRate < 5 ? "bg-success" :
                                        cpuRate < 10 ? "bg-info" :
                                        cpuRate < 20 ? "bg-secondary" :
                                        cpuRate < 40 ? "bg-warning" :
                                        "bg-danger";

                                    // RAM
                                    var mem = agent.GetMemUsed();

                                    // NetWork
                                    var net = showLast30 ? agent.GetNetworkLast30Seconds() : agent.GetNetwork();

                                    // Disk
                                    var disk = showLast30 ? agent.GetDiskLast30Seconds() : agent.GetDisk();
                                    var diskUseRatio = agent.UsedRoot / (double)agent.TotalRoot;
                                    var message = $"{agent.UsedRoot}GB / {agent.TotalRoot}GB";
                                    var diskColor =
                                        diskUseRatio < 0.6 ? "bg-success" :
                                        diskUseRatio < 0.7 ? "bg-warning" :
                                        "bg-danger";

                                    // OS
                                    var osFirstTwoWords = string.Join(" ", agent.OsName.Split(' ').Take(2)).Trim();

                                    // Overall
                                    var reason = isOutDated ? "Server is out of sync. " : "";
                                    reason += loadRate > 60 ? "Load critical. " : loadRate > 30 ? "Load warning. " : "";
                                    reason += cpuRate > 40 ? "CPU usage critical. " : cpuRate > 20 ? "CPU usage warning. " : "";
                                    reason += diskUseRatio > 0.7 ? "Disk space critical. " : diskUseRatio > 0.6 ? "Disk space warning. " : "";

                                <tr>
                                    <td>
                                        @if (isOutDated)
                                        {
                                            <i class="align-middle me-2 text-muted" data-lucide="activity" data-bs-toggle="tooltip" data-placement="bottom" title="@reason"></i>
                                        }
                                        else if (loadRate > 60 || cpuRate > 40 || diskUseRatio > 0.7)
                                        {
                                            <label data-bs-toggle="tooltip" data-placement="bottom" title="@reason">
                                                <i class="align-middle me-2 text-danger" data-lucide="alert-triangle"></i>
                                            </label>
                                        }
                                        else if (loadRate > 30 || cpuRate > 20 || diskUseRatio > 0.6)
                                        {
                                            <i class="align-middle me-2 text-warning" data-lucide="alert-circle" data-bs-toggle="tooltip" data-placement="bottom" title="@reason"></i>
                                        }
                                        else
                                        {
                                            <i class="align-middle me-2 text-success" data-lucide="check-circle"></i>
                                        }
                                        @agent.Ip
                                    </td>
                                    <td>
                                        @agent.Hostname
                                        @if (!string.IsNullOrWhiteSpace(agent.Motd))
                                        {
                                            <i class="align-middle ms-1" data-lucide="mail" data-bs-toggle="tooltip" data-placement="bottom" title="@agent.Motd"></i>
                                        }
                                    </td>
                                    <td class="d-none d-lg-table-cell" data-sort="@agent.GetSkuInNumber()">@agent.GetSku()</td>
                                    <td class="d-none d-xl-table-cell" data-utc-time="@agent.BootTime.ToHtmlDateTime()" data-sort="@agent.BootTime.Ticks">
                                    </td>

                                    <td data-sort="@loadRate">
                                        <div class="d-flex flex-column w-100">
                                            <span class="me-2 mb-1 text-muted">@loadRate.ToString("F0")%</span>
                                            <div class="progress progress-sm w-100">
                                                <div class="progress-bar @colorLoad"
                                                     role="progressbar" style="width: @(loadRate)%" aria-valuenow="@loadRate" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom"
                                                     title="@promptTextLoad"></div>
                                            </div>
                                        </div>
                                    </td>

                                    <td data-sort="@cpuRate">
                                        <div class="d-flex flex-column w-100">
                                            <span class="me-2 mb-1 text-muted">@cpuRate.ToString("F0")%</span>
                                            <div class="progress progress-sm w-100">
                                                <div class="progress-bar @color"
                                                     role="progressbar" style="width: @(cpuRate)%" aria-valuenow="@cpuRate" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom"
                                                     title="@promptText"></div>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="d-none d-lg-table-cell">
                                        @if (cpuRate < 30)
                                        {
                                            <span class="badge badge-subtle-secondary">@(agent.Process)</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-subtle-danger">@(agent.Process)</span>
                                        }
                                    </td>

                                    <td data-sort="@mem.UsedRate">
                                        <div class="progress progress-sm">
                                            <div class="progress-bar-striped bg-success" role="progressbar" style="width: @(mem.UsedRate)%" aria-valuenow="@(mem.UsedRate)" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom" title="Used RAM: @mem.Used.HumanReadableSize()"></div>
                                            <div class="progress-bar-striped bg-info" role="progressbar" style="width: @(mem.BufRate)%" aria-valuenow="@(mem.BufRate)" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom" title="Buffer RAM: @mem.Buf.HumanReadableSize()"></div>
                                            <div class="progress-bar-striped bg-warning" role="progressbar" style="width: @(mem.CacheRate)%" aria-valuenow="@(mem.CacheRate)" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom" title="Cache RAM: @mem.Cache.HumanReadableSize()"></div>
                                        </div>
                                    </td>

                                    <td class="d-none d-md-table-cell" data-sort="@net.Recv">
                                        @net.Recv.HumanReadableSize()@unit
                                    </td>
                                    <td class="d-none d-md-table-cell" data-sort="@net.Send">
                                        @net.Send.HumanReadableSize()@unit
                                    </td>

                                    <td data-sort="@diskUseRatio">
                                        <div class="d-flex flex-column w-100">
                                            <span class="me-2 mb-1 text-muted">@(Math.Round(diskUseRatio * 100))%</span>
                                            <div class="progress progress-sm w-100">
                                                <div class="progress-bar @diskColor" role="progressbar" style="width: @(diskUseRatio * 100)%" aria-valuenow="@(diskUseRatio * 100)" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-placement="bottom" title="@message"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-xl-table-cell" data-sort="@disk.Read">
                                        @disk.Read.HumanReadableSize()@unit
                                    </td>
                                    <td class="d-none d-xl-table-cell" data-sort="@disk.Writ">
                                        @disk.Writ.HumanReadableSize()@unit
                                    </td>

                                    <td class="d-none d-xl-table-cell">@osFirstTwoWords</td>

                                    <td>
                                        <a class="btn btn-light btn-sm" asp-controller="Dashboard" asp-action="Details" asp-route-id="@agent.ClientId">
                                            @Localizer["Details"]
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>
		document.addEventListener("DOMContentLoaded", function() {
			// Datatables Responsive
            // ("#datatables-reponsive")
			$('#logTable').DataTable({
                "responsive": true,
                "paging": true,
                "pageLength": 25,
                "searching": false,
                "info": false,
                "order": [[0, "asc"]],
                "drawCallback": function () {
                    $('[data-toggle="tooltip"]').tooltip({
                        trigger: 'hover'
                    });
                }
			});

            // Activate tooltip tool
            $('[data-toggle="tooltip"]').tooltip({
                trigger: 'hover'
            });
		});
	</script>
}
